node {
     def mavenHome =  tool name: "maven-3", type: "maven"
     def mavenCMD = "${mavenHome}/bin/mvn"
    stage('git checkout') {
        git url:'https://github.com/bcreddydevops/mavenweb-demo.git', branch: 'main'
    }
    stage('Maven Build') {
         sh "${mavenCMD} clean package"
    }
    stage("sonarqube analysis"){
        withSonarQubeEnv(installationName: 'sonarqube-8', credentialsId: 'sonarqube-creds') {
         sh "${mavenCMD} clean sonar:sonar"
       }
       timeout(5) {
         def qg = waitForQualityGate()
         if (qg.status != 'OK') {
         error "Pipeline aborted due to quality gate failure: ${qg.status}"
         }
     }
    }
    stage("Nexus Upload"){
       sh "${mavenCMD} clean deploy"
    }
}
